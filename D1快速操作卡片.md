# D1 数据库快速操作卡片

## 🎯 核心概念
- **本地开发**：操作 `.wrangler/state/v3/d1/` 下的 SQLite 文件
- **生产环境**：通过 REST API 操作远程 D1 数据库
- **环境切换**：通过 `NODE_ENV` 环境变量控制

## ⚡ 常用命令

### 🔧 生成迁移
```bash
bun run db:generate
```

### 📦 应用迁移
```bash
# 本地开发
bun run db:migrate:dev

# 生产环境
bun run db:migrate:prod
```

### 👀 查看数据库
```bash
# 本地数据库
bun run db:studio:dev

# 生产数据库
bun run db:studio:prod
```

## 🔑 环境变量配置

### 必需的三个变量
```env
CLOUDFLARE_D1_ACCOUNT_ID=你的账户ID
DATABASE=你的数据库ID  
CLOUDFLARE_D1_API_TOKEN=你的API令牌
```

### 获取方式
1. **Account ID**：Cloudflare Dashboard 右侧边栏
2. **Database ID**：D1 数据库详情页
3. **API Token**：Profile → API Tokens → Create Token

## 🏗️ 文件结构
```
.wrangler/state/v3/d1/     # 本地 SQLite 文件
drizzle/                   # 迁移文件
src/server/db/schema.ts    # 数据库表结构
wrangler.toml              # D1 配置
.env                       # 环境变量
```

## 🚨 常见问题速查

| 问题 | 解决方案 |
|------|----------|
| 找不到 .sqlite 文件 | 先运行 `bun run dev` |
| 403 Forbidden | 检查 API Token 权限 |
| 迁移失败 | 手动执行 `wrangler d1 execute` |
| 环境变量无效 | 检查 `.env` 文件是否存在 |

## 🔄 工作流程

### 开发阶段
1. 修改 `schema.ts`
2. `bun run db:generate`
3. `bun run db:migrate:dev`
4. `bun run dev`

### 部署阶段
1. `bun run db:migrate:prod`
2. `bun run build:cf`
3. `bun run deploy`

## 💡 关键要点
- 本地和生产环境操作不同的数据库
- 环境变量是连接生产环境的关键
- 迁移文件需要先应用到生产环境再部署代码
- 永远不要提交 `.env` 文件到 Git
