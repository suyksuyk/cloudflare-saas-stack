# 环境变量详细说明

## 必须设置的环境变量

### 1. AUTH_SECRET（必须设置）

**作用**：
- NextAuth.js 用于加密和签名 JWT 令牌、会话数据
- 防止用户会话被篡改
- 确保认证安全性

**为什么必须设置**：
- 没有 AUTH_SECRET，NextAuth.js 无法正常工作
- 用户无法登录或会话会立即失效
- 生产环境中这是安全必需品

**如何生成 AUTH_SECRET**：

#### 方法 1：使用 OpenSSL（推荐）
```bash
openssl rand -base64 32
```

#### 方法 2：使用 Node.js
```bash
node -e "console.log(require('crypto').randomBytes(32).toString('base64'))"
```

#### 方法 3：在线生成器
访问：https://generate-secret.vercel.app/32

**示例值**：
```
AUTH_SECRET=G9k8V2xR5yH7nM3pQ6wE1tA4sD8fG2hJ5kL7zX9cV3bN6mP1qR4uY8iO2aS5dF
```

### 2. AUTH_URL（可选但推荐）

**作用**：
- 告诉 NextAuth.js 应用的完整 URL
- 确保回调 URL 和重定向 URL 正确
- 避免在不同环境下的 URL 问题

**什么时候需要设置**：
- 生产环境（必须）
- 使用自定义域名
- 在子路径下部署应用

**如何设置**：
```
# 开发环境
AUTH_URL=http://localhost:3000

# Cloudflare Pages 生产环境
AUTH_URL=https://your-project.pages.dev

# 自定义域名
AUTH_URL=https://your-domain.com
```

## 环境变量配置位置

### 1. 开发环境
在项目根目录创建 `.env.local` 文件：
```env
AUTH_SECRET=your-generated-secret-here
AUTH_URL=http://localhost:3000
```

### 2. Cloudflare Pages
在 Cloudflare Dashboard > Pages > Settings > Environment variables 中添加：

**Production 环境**：
```
AUTH_SECRET=your-generated-secret-here
AUTH_URL=https://your-project.pages.dev
```

**Preview 环境**：
```
AUTH_SECRET=your-generated-secret-here
AUTH_URL=https://preview-your-project.pages.dev
```

## 安全注意事项

### 1. AUTH_SECRET 安全
- ✅ 使用足够长的随机字符串（至少 32 字符）
- ✅ 每个环境使用不同的 SECRET
- ✅ 定期轮换（虽然不强制）
- ❌ 不要使用简单的单词或可预测的字符串
- ❌ 不要在代码中硬编码
- ❌ 不要提交到 Git 仓库

### 2. 环境隔离
```env
# 开发环境
AUTH_SECRET=dev-secret-123...
AUTH_URL=http://localhost:3000

# 生产环境  
AUTH_SECRET=prod-secret-456...
AUTH_URL=https://your-project.pages.dev
```

## 故障排除

### 1. 缺少 AUTH_SECRET 的错误
```
Error: AUTH_SECRET environment variable is not set
```
**解决**：设置 AUTH_SECRET 环境变量

### 2. 无效的 AUTH_SECRET
```
Error: JWT malformed
```
**解决**：重新生成一个新的 AUTH_SECRET

### 3. 回调 URL 错误
```
Error: Invalid callback URL
```
**解决**：设置正确的 AUTH_URL

## 快速设置步骤

### 1. 生成 SECRET
```bash
# 生成一个新的 secret
AUTH_SECRET=$(openssl rand -base64 32)
echo "AUTH_SECRET=$AUTH_SECRET"
```

### 2. 设置 Cloudflare Pages
1. 进入 Cloudflare Pages 控制台
2. 选择你的项目
3. Settings > Environment variables
4. 添加：
   - `AUTH_SECRET`: 生成的密钥
   - `AUTH_URL`: 你的 Pages 域名
   - `SKIP_ENV_VALIDATION`: `true`（可选，跳过验证）

### 3. 重新部署
设置环境变量后，触发新的部署以应用更改。

## 验证设置

部署后，检查：
1. 应用能否正常加载
2. 登录功能是否工作
3. 会话是否保持
4. 没有认证相关的错误

如果一切正常，说明环境变量配置正确！
