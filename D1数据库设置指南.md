# Cloudflare D1 æ•°æ®åº“å®Œæ•´è®¾ç½®æŒ‡å—

## æ¦‚è¿°

D1 æ˜¯ Cloudflare æä¾›çš„æ— æœåŠ¡å™¨ SQLite æ•°æ®åº“ã€‚æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ Cloudflare å¹³å°ä¸Šè®¾ç½®å’Œä½¿ç”¨ D1 æ•°æ®åº“ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

- å·²æ³¨å†Œ Cloudflare è´¦æˆ·
- å·²å®‰è£… Node.js å’Œ Bun
- å·²å®‰è£… Wrangler CLI
- å·²æœ‰ Cloudflare Pages é¡¹ç›®

## ğŸ—ï¸ D1 æ¶æ„è¯´æ˜

### æœ¬åœ°å¼€å‘ç¯å¢ƒ
- æœ¬åœ°å¼€å‘æ—¶ï¼ŒWrangler ä¼šåœ¨ `.wrangler/state/v3/d1` ç›®å½•ä¸‹è‡ªåŠ¨ç”Ÿæˆ SQLite æ–‡ä»¶
- å¼€å‘æœåŠ¡å™¨ï¼ˆ`bun run dev`ï¼‰ç›´æ¥ä¸æœ¬åœ° D1 ä¼šè¯äº¤äº’
- Drizzle Kit ç›´æ¥æ“ä½œè¿™äº› SQLite æ–‡ä»¶ä½œä¸ºå¸¸è§„æ•°æ®åº“

### ç”Ÿäº§ç¯å¢ƒ
- ç”Ÿäº§ç¯å¢ƒé€šè¿‡ REST API ä¸è¿œç¨‹ D1 æ•°æ®åº“äº¤äº’
- ä½¿ç”¨ D1 HTTP é©±åŠ¨ç¨‹åºè¿›è¡Œè¿æ¥
- éœ€è¦é…ç½®ç¯å¢ƒå˜é‡è¿›è¡Œèº«ä»½éªŒè¯

## ğŸš€ å®Œæ•´è®¾ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º D1 æ•°æ®åº“

1. **ç™»å½• Cloudflare Dashboard**
   ```
   è®¿é—®ï¼šhttps://dash.cloudflare.com
   ```

2. **åˆ›å»º D1 æ•°æ®åº“**
   - åœ¨å·¦ä¾§å¯¼èˆªæ é€‰æ‹© "Workers & Pages"
   - ç‚¹å‡» "D1" é€‰é¡¹å¡
   - ç‚¹å‡» "Create database" æŒ‰é’®
   - è¾“å…¥æ•°æ®åº“åç§°ï¼ˆä¾‹å¦‚ï¼š`cf_saas-db`ï¼‰
   - ç‚¹å‡» "Create" å®Œæˆåˆ›å»º

3. **è·å–æ•°æ®åº“ä¿¡æ¯**
   - åˆ›å»ºå®Œæˆåï¼Œè®°ä¸‹ä»¥ä¸‹ä¿¡æ¯ï¼š
     - **Database ID**ï¼šæ•°æ®åº“å”¯ä¸€æ ‡è¯†ç¬¦
     - **Database Name**ï¼šæ•°æ®åº“åç§°

### ç¬¬äºŒæ­¥ï¼šé…ç½® Wrangler

1. **ç¼–è¾‘ `wrangler.toml` æ–‡ä»¶**
   ```toml
   [[d1_databases]]
   binding = "DATABASE"
   database_name = "ä½ çš„æ•°æ®åº“åç§°"
   database_id = "ä½ çš„æ•°æ®åº“ID"
   migrations_dir = "./drizzle"
   ```

2. **ç¤ºä¾‹é…ç½®**
   ```toml
   [[d1_databases]]
   binding = "DATABASE"
   database_name = "cf_saas-db"
   database_id = "bba6a9f4-2357-4474-9150-bea37ac24654"
   migrations_dir = "./drizzle"
   ```

### ç¬¬ä¸‰æ­¥ï¼šè·å– API å‡­æ®

1. **è·å– Account ID**
   - åœ¨ Cloudflare Dashboard å³ä¾§è¾¹æ æ‰¾åˆ° "Account ID"
   - å¤åˆ¶è¿™ä¸ª ID

2. **åˆ›å»º API Token**
   - è¿›å…¥ "My Profile" â†’ "API Tokens"
   - ç‚¹å‡» "Create Token"
   - é€‰æ‹© "Custom token" æ¨¡æ¿
   - é…ç½®æƒé™ï¼š
     - **Account**ï¼š`Cloudflare D1:Edit`
     - **Zone Resources**ï¼š`All zones` æˆ–ç‰¹å®šåŒºåŸŸ
   - ç‚¹å‡» "Continue to summary" â†’ "Create Token"
   - å¤åˆ¶ç”Ÿæˆçš„ Token

### ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡

1. **ç¼–è¾‘ `.env.example` æ–‡ä»¶**
   ```env
   # è¿è¡Œ drizzle-kit åœ¨ç”Ÿäº§æ•°æ®åº“ä¸Šçš„å˜é‡
   # bun run db:migrate:prod
   CLOUDFLARE_D1_ACCOUNT_ID=ä½ çš„Account_ID
   DATABASE=ä½ çš„Database_ID
   CLOUDFLARE_D1_API_TOKEN=ä½ çš„API_Token
   ```

2. **åˆ›å»º `.env` æ–‡ä»¶**
   ```bash
   cp .env.example .env
   ```
   
3. **å¡«å…¥å®é™…å€¼**
   ```env
   CLOUDFLARE_D1_ACCOUNT_ID=1234567890abcdef1234567890abcdef
   DATABASE=bba6a9f4-2357-4474-9150-bea37ac24654
   CLOUDFLARE_D1_API_TOKEN=abcdef1234567890abcdef1234567890abcdef
   ```

## ğŸ› ï¸ æ•°æ®åº“æ“ä½œå‘½ä»¤

### å¼€å‘ç¯å¢ƒæ“ä½œ

#### ç”Ÿæˆè¿ç§»æ–‡ä»¶
```bash
bun run db:generate
```
- æ ¹æ® schema.ts æ–‡ä»¶ç”Ÿæˆ SQL è¿ç§»æ–‡ä»¶
- æ–‡ä»¶ä¿å­˜åœ¨ `drizzle/` ç›®å½•ä¸‹

#### åº”ç”¨è¿ç§»ï¼ˆæœ¬åœ°ï¼‰
```bash
bun run db:migrate:dev
```
- å°†è¿ç§»åº”ç”¨åˆ°æœ¬åœ° SQLite æ•°æ®åº“
- ä¿®æ”¹ `.wrangler/state/v3/d1/` ä¸‹çš„æ–‡ä»¶

#### æŸ¥çœ‹æœ¬åœ°æ•°æ®åº“
```bash
bun run db:studio:dev
```
- å¯åŠ¨ Drizzle Studio æœ¬åœ°ç•Œé¢
- å¯è§†åŒ–æŸ¥çœ‹å’Œç¼–è¾‘æœ¬åœ°æ•°æ®åº“

### ç”Ÿäº§ç¯å¢ƒæ“ä½œ

#### åº”ç”¨è¿ç§»ï¼ˆç”Ÿäº§ï¼‰
```bash
bun run db:migrate:prod
```
- å°†è¿ç§»åº”ç”¨åˆ°è¿œç¨‹ D1 æ•°æ®åº“
- é€šè¿‡ REST API æ“ä½œç”Ÿäº§æ•°æ®åº“

#### æŸ¥çœ‹ç”Ÿäº§æ•°æ®åº“
```bash
bun run db:studio:prod
```
- å¯åŠ¨ Drizzle Studio è¿æ¥ç”Ÿäº§æ•°æ®åº“
- å¯è§†åŒ–æŸ¥çœ‹è¿œç¨‹æ•°æ®åº“æ•°æ®

## ğŸ“ é¡¹ç›®æ–‡ä»¶ç»“æ„

```
é¡¹ç›®æ ¹ç›®å½•/
â”œâ”€â”€ .wrangler/
â”‚   â””â”€â”€ state/
â”‚       â””â”€â”€ v3/
â”‚           â””â”€â”€ d1/           # æœ¬åœ° SQLite æ–‡ä»¶
â”œâ”€â”€ drizzle/
â”‚   â”œâ”€â”€ 0000_setup.sql        # è¿ç§»æ–‡ä»¶
â”‚   â””â”€â”€ meta/                 # è¿ç§»å…ƒæ•°æ®
â”œâ”€â”€ src/server/db/
â”‚   â”œâ”€â”€ index.ts              # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ schema.ts             # æ•°æ®åº“è¡¨ç»“æ„
â”œâ”€â”€ .env.example              # ç¯å¢ƒå˜é‡æ¨¡æ¿
â”œâ”€â”€ .env                      # å®é™…ç¯å¢ƒå˜é‡
â”œâ”€â”€ wrangler.toml             # Wrangler é…ç½®
â””â”€â”€ drizzle.config.ts         # Drizzle é…ç½®
```

## ğŸ”§ Drizzle é…ç½®è¯´æ˜

### å¼€å‘ç¯å¢ƒé…ç½®
```typescript
{
  dialect: "sqlite",
  dbCredentials: {
    url: getLocalD1DB(),  // è‡ªåŠ¨è·å–æœ¬åœ° SQLite æ–‡ä»¶è·¯å¾„
  }
}
```

### ç”Ÿäº§ç¯å¢ƒé…ç½®
```typescript
{
  dialect: "sqlite",
  driver: "d1-http",
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_D1_ACCOUNT_ID,
    databaseId: process.env.DATABASE,
    token: process.env.CLOUDFLARE_D1_API_TOKEN,
  }
}
```

## ğŸš¨ å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### 1. æœ¬åœ°æ•°æ®åº“æ–‡ä»¶æ‰¾ä¸åˆ°
**é—®é¢˜**ï¼š`Error: .sqlite file not found in .wrangler`

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å…ˆè¿è¡Œå¼€å‘æœåŠ¡å™¨ç”Ÿæˆæ•°æ®åº“æ–‡ä»¶
bun run dev
# ç„¶åå†è¿è¡Œæ•°æ®åº“å‘½ä»¤
bun run db:migrate:dev
```

### 2. API Token æƒé™ä¸è¶³
**é—®é¢˜**ï¼š`403 Forbidden` é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ API Token æ˜¯å¦åŒ…å« `Cloudflare D1:Edit` æƒé™
- ç¡®è®¤ Account ID å’Œ Database ID æ­£ç¡®

### 3. è¿ç§»å¤±è´¥
**é—®é¢˜**ï¼šè¿ç§»åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒå¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# æ£€æŸ¥è¿ç§»æ–‡ä»¶
cat drizzle/0000_setup.sql

# æ‰‹åŠ¨æ‰§è¡Œ SQL
wrangler d1 execute cf_saas-db --file=drizzle/0000_setup.sql
```

### 4. ç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ
**é—®é¢˜**ï¼šç”Ÿäº§ç¯å¢ƒå‘½ä»¤æ— æ³•è¯»å–ç¯å¢ƒå˜é‡

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ç¡®è®¤ .env æ–‡ä»¶å­˜åœ¨
ls -la .env

# æ‰‹åŠ¨è®¾ç½®ç¯å¢ƒå˜é‡
export CLOUDFLARE_D1_ACCOUNT_ID="ä½ çš„ID"
export DATABASE="ä½ çš„æ•°æ®åº“ID"
export CLOUDFLARE_D1_API_TOKEN="ä½ çš„Token"
```

## ğŸ“Š æ•°æ®åº“ä½¿ç”¨ç¤ºä¾‹

### åœ¨ä»£ç ä¸­ä½¿ç”¨ D1
```typescript
// src/server/db/index.ts
import { drizzle } from 'drizzle-orm/d1';
import * as schema from './schema';

export function createDB(env: any) {
  return drizzle(env.DATABASE, { schema });
}

// åœ¨ API è·¯ç”±ä¸­ä½¿ç”¨
export async function GET(request: Request) {
  const db = createDB(process.env);
  const users = await db.select().from(schema.users);
  return Response.json(users);
}
```

## ğŸ”„ éƒ¨ç½²æµç¨‹

### 1. å¼€å‘é˜¶æ®µ
```bash
# 1. ä¿®æ”¹ schema
# 2. ç”Ÿæˆè¿ç§»
bun run db:generate

# 3. æœ¬åœ°æµ‹è¯•
bun run db:migrate:dev
bun run dev
```

### 2. éƒ¨ç½²åˆ°ç”Ÿäº§
```bash
# 1. åº”ç”¨ç”Ÿäº§è¿ç§»
bun run db:migrate:prod

# 2. æ„å»ºå’Œéƒ¨ç½²
bun run build:cf
bun run deploy
```

## ğŸ›¡ï¸ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡å®‰å…¨**
   - æ°¸è¿œä¸è¦å°† `.env` æ–‡ä»¶æäº¤åˆ° Git
   - ä½¿ç”¨ `.gitignore` æ’é™¤æ•æ„Ÿæ–‡ä»¶

2. **API Token ç®¡ç†**
   - å®šæœŸè½®æ¢ API Token
   - ä½¿ç”¨æœ€å°æƒé™åŸåˆ™

3. **æ•°æ®åº“å¤‡ä»½**
   - å®šæœŸå¤‡ä»½ç”Ÿäº§æ•°æ®åº“
   - ä½¿ç”¨ `wrangler d1 export` å‘½ä»¤

## ğŸ“š æœ‰ç”¨å‘½ä»¤å‚è€ƒ

### Wrangler D1 å‘½ä»¤
```bash
# åˆ›å»ºæ•°æ®åº“
wrangler d1 create æ•°æ®åº“åç§°

# æ‰§è¡Œ SQL
wrangler d1 execute æ•°æ®åº“åç§° --command="SELECT * FROM users"

# æ‰§è¡Œ SQL æ–‡ä»¶
wrangler d1 execute æ•°æ®åº“åç§° --file=script.sql

# å¯¼å‡ºæ•°æ®åº“
wrangler d1 export æ•°æ®åº“åç§° --output=backup.sql

# å¯¼å…¥æ•°æ®åº“
wrangler d1 import æ•°æ®åº“åç§° --file=backup.sql
```

### Drizzle Kit å‘½ä»¤
```bash
# ç”Ÿæˆè¿ç§»
drizzle-kit generate

# åº”ç”¨è¿ç§»
drizzle-kit migrate

# æ‰“å¼€ Studio
drizzle-kit studio

# æ£€æŸ¥çŠ¶æ€
drizzle-kit status
```

## ğŸ¯ æ€»ç»“

é€šè¿‡æœ¬æŒ‡å—ï¼Œæ‚¨åº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… åˆ›å»ºå’Œé…ç½® Cloudflare D1 æ•°æ®åº“
2. âœ… è®¾ç½®æœ¬åœ°å’Œå¼€å‘ç¯å¢ƒ
3. âœ… é…ç½®ç”Ÿäº§ç¯å¢ƒçš„ç¯å¢ƒå˜é‡
4. âœ… ä½¿ç”¨ Drizzle ORM ç®¡ç†æ•°æ®åº“è¿ç§»
5. âœ… åœ¨æœ¬åœ°å’Œç”Ÿäº§ç¯å¢ƒä¸­æ“ä½œæ•°æ®åº“
6. âœ… éƒ¨ç½²åº”ç”¨åˆ° Cloudflare Pages

è®°ä½ï¼šå¼€å‘ç¯å¢ƒæ“ä½œæœ¬åœ° SQLite æ–‡ä»¶ï¼Œç”Ÿäº§ç¯å¢ƒé€šè¿‡ REST API æ“ä½œè¿œç¨‹ D1 æ•°æ®åº“ã€‚ç¡®ä¿ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®ï¼Œè¿™æ˜¯è¿æ¥ç”Ÿäº§ç¯å¢ƒçš„å…³é”®ã€‚
