# Cloudflare D1 数据库完整设置指南

## 概述

D1 是 Cloudflare 提供的无服务器 SQLite 数据库。本指南将详细介绍如何在 Cloudflare 平台上设置和使用 D1 数据库。

## 📋 前置要求

- 已注册 Cloudflare 账户
- 已安装 Node.js 和 Bun
- 已安装 Wrangler CLI
- 已有 Cloudflare Pages 项目

## 🏗️ D1 架构说明

### 本地开发环境
- 本地开发时，Wrangler 会在 `.wrangler/state/v3/d1` 目录下自动生成 SQLite 文件
- 开发服务器（`bun run dev`）直接与本地 D1 会话交互
- Drizzle Kit 直接操作这些 SQLite 文件作为常规数据库

### 生产环境
- 生产环境通过 REST API 与远程 D1 数据库交互
- 使用 D1 HTTP 驱动程序进行连接
- 需要配置环境变量进行身份验证

## 🚀 完整设置步骤

### 第一步：创建 D1 数据库

1. **登录 Cloudflare Dashboard**
   ```
   访问：https://dash.cloudflare.com
   ```

2. **创建 D1 数据库**
   - 在左侧导航栏选择 "Workers & Pages"
   - 点击 "D1" 选项卡
   - 点击 "Create database" 按钮
   - 输入数据库名称（例如：`cf_saas-db`）
   - 点击 "Create" 完成创建

3. **获取数据库信息**
   - 创建完成后，记下以下信息：
     - **Database ID**：数据库唯一标识符
     - **Database Name**：数据库名称

### 第二步：配置 Wrangler

1. **编辑 `wrangler.toml` 文件**
   ```toml
   [[d1_databases]]
   binding = "DATABASE"
   database_name = "你的数据库名称"
   database_id = "你的数据库ID"
   migrations_dir = "./drizzle"
   ```

2. **示例配置**
   ```toml
   [[d1_databases]]
   binding = "DATABASE"
   database_name = "cf_saas-db"
   database_id = "bba6a9f4-2357-4474-9150-bea37ac24654"
   migrations_dir = "./drizzle"
   ```

### 第三步：获取 API 凭据

1. **获取 Account ID**
   - 在 Cloudflare Dashboard 右侧边栏找到 "Account ID"
   - 复制这个 ID

2. **创建 API Token**
   - 进入 "My Profile" → "API Tokens"
   - 点击 "Create Token"
   - 选择 "Custom token" 模板
   - 配置权限：
     - **Account**：`Cloudflare D1:Edit`
     - **Zone Resources**：`All zones` 或特定区域
   - 点击 "Continue to summary" → "Create Token"
   - 复制生成的 Token

### 第四步：配置环境变量

1. **编辑 `.env.example` 文件**
   ```env
   # 运行 drizzle-kit 在生产数据库上的变量
   # bun run db:migrate:prod
   CLOUDFLARE_D1_ACCOUNT_ID=你的Account_ID
   DATABASE=你的Database_ID
   CLOUDFLARE_D1_API_TOKEN=你的API_Token
   ```

2. **创建 `.env` 文件**
   ```bash
   cp .env.example .env
   ```
   
3. **填入实际值**
   ```env
   CLOUDFLARE_D1_ACCOUNT_ID=1234567890abcdef1234567890abcdef
   DATABASE=bba6a9f4-2357-4474-9150-bea37ac24654
   CLOUDFLARE_D1_API_TOKEN=abcdef1234567890abcdef1234567890abcdef
   ```

## 🛠️ 数据库操作命令

### 开发环境操作

#### 生成迁移文件
```bash
bun run db:generate
```
- 根据 schema.ts 文件生成 SQL 迁移文件
- 文件保存在 `drizzle/` 目录下

#### 应用迁移（本地）
```bash
bun run db:migrate:dev
```
- 将迁移应用到本地 SQLite 数据库
- 修改 `.wrangler/state/v3/d1/` 下的文件

#### 查看本地数据库
```bash
bun run db:studio:dev
```
- 启动 Drizzle Studio 本地界面
- 可视化查看和编辑本地数据库

### 生产环境操作

#### 应用迁移（生产）
```bash
bun run db:migrate:prod
```
- 将迁移应用到远程 D1 数据库
- 通过 REST API 操作生产数据库

#### 查看生产数据库
```bash
bun run db:studio:prod
```
- 启动 Drizzle Studio 连接生产数据库
- 可视化查看远程数据库数据

## 📁 项目文件结构

```
项目根目录/
├── .wrangler/
│   └── state/
│       └── v3/
│           └── d1/           # 本地 SQLite 文件
├── drizzle/
│   ├── 0000_setup.sql        # 迁移文件
│   └── meta/                 # 迁移元数据
├── src/server/db/
│   ├── index.ts              # 数据库连接
│   └── schema.ts             # 数据库表结构
├── .env.example              # 环境变量模板
├── .env                      # 实际环境变量
├── wrangler.toml             # Wrangler 配置
└── drizzle.config.ts         # Drizzle 配置
```

## 🔧 Drizzle 配置说明

### 开发环境配置
```typescript
{
  dialect: "sqlite",
  dbCredentials: {
    url: getLocalD1DB(),  // 自动获取本地 SQLite 文件路径
  }
}
```

### 生产环境配置
```typescript
{
  dialect: "sqlite",
  driver: "d1-http",
  dbCredentials: {
    accountId: process.env.CLOUDFLARE_D1_ACCOUNT_ID,
    databaseId: process.env.DATABASE,
    token: process.env.CLOUDFLARE_D1_API_TOKEN,
  }
}
```

## 🚨 常见问题和解决方案

### 1. 本地数据库文件找不到
**问题**：`Error: .sqlite file not found in .wrangler`

**解决方案**：
```bash
# 先运行开发服务器生成数据库文件
bun run dev
# 然后再运行数据库命令
bun run db:migrate:dev
```

### 2. API Token 权限不足
**问题**：`403 Forbidden` 错误

**解决方案**：
- 检查 API Token 是否包含 `Cloudflare D1:Edit` 权限
- 确认 Account ID 和 Database ID 正确

### 3. 迁移失败
**问题**：迁移应用到生产环境失败

**解决方案**：
```bash
# 检查迁移文件
cat drizzle/0000_setup.sql

# 手动执行 SQL
wrangler d1 execute cf_saas-db --file=drizzle/0000_setup.sql
```

### 4. 环境变量未生效
**问题**：生产环境命令无法读取环境变量

**解决方案**：
```bash
# 确认 .env 文件存在
ls -la .env

# 手动设置环境变量
export CLOUDFLARE_D1_ACCOUNT_ID="你的ID"
export DATABASE="你的数据库ID"
export CLOUDFLARE_D1_API_TOKEN="你的Token"
```

## 📊 数据库使用示例

### 在代码中使用 D1
```typescript
// src/server/db/index.ts
import { drizzle } from 'drizzle-orm/d1';
import * as schema from './schema';

export function createDB(env: any) {
  return drizzle(env.DATABASE, { schema });
}

// 在 API 路由中使用
export async function GET(request: Request) {
  const db = createDB(process.env);
  const users = await db.select().from(schema.users);
  return Response.json(users);
}
```

## 🔄 部署流程

### 1. 开发阶段
```bash
# 1. 修改 schema
# 2. 生成迁移
bun run db:generate

# 3. 本地测试
bun run db:migrate:dev
bun run dev
```

### 2. 部署到生产
```bash
# 1. 应用生产迁移
bun run db:migrate:prod

# 2. 构建和部署
bun run build:cf
bun run deploy
```

## 🛡️ 安全注意事项

1. **环境变量安全**
   - 永远不要将 `.env` 文件提交到 Git
   - 使用 `.gitignore` 排除敏感文件

2. **API Token 管理**
   - 定期轮换 API Token
   - 使用最小权限原则

3. **数据库备份**
   - 定期备份生产数据库
   - 使用 `wrangler d1 export` 命令

## 📚 有用命令参考

### Wrangler D1 命令
```bash
# 创建数据库
wrangler d1 create 数据库名称

# 执行 SQL
wrangler d1 execute 数据库名称 --command="SELECT * FROM users"

# 执行 SQL 文件
wrangler d1 execute 数据库名称 --file=script.sql

# 导出数据库
wrangler d1 export 数据库名称 --output=backup.sql

# 导入数据库
wrangler d1 import 数据库名称 --file=backup.sql
```

### Drizzle Kit 命令
```bash
# 生成迁移
drizzle-kit generate

# 应用迁移
drizzle-kit migrate

# 打开 Studio
drizzle-kit studio

# 检查状态
drizzle-kit status
```

## 🎯 总结

通过本指南，您应该能够：

1. ✅ 创建和配置 Cloudflare D1 数据库
2. ✅ 设置本地和开发环境
3. ✅ 配置生产环境的环境变量
4. ✅ 使用 Drizzle ORM 管理数据库迁移
5. ✅ 在本地和生产环境中操作数据库
6. ✅ 部署应用到 Cloudflare Pages

记住：开发环境操作本地 SQLite 文件，生产环境通过 REST API 操作远程 D1 数据库。确保环境变量配置正确，这是连接生产环境的关键。
